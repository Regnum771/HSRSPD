
<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <link rel="stylesheet" href="mystyle.css">
</head>

<body>
    <span class = "character-config">
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
        </div>
        <div>        
            <label for="spd1">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
        </div>
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
        </div>
        <div>        
            <label for="spd1">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
        </div>
    </span>
    <div>
        <svg id = "timeline" width = 1000 height = 200>
            <g>
                <line x1="150" y1="0" x2="150" y2="200" stroke="black"/>
                <line x1="250" y1="0" x2="250" y2="200" stroke="black"/>
                <line x1="350" y1="0" x2="350" y2="200" stroke="black"/>
                <line x1="450" y1="0" x2="450" y2="200" stroke="black"/>
                <line x1="550" y1="0" x2="550" y2="200" stroke="black"/>
                <line x1="650" y1="0" x2="650" y2="200" stroke="black"/>
                <line x1="750" y1="0" x2="750" y2="200" stroke="black"/>
            </g>
        </svg>
    </div>
    <div>
        <p>Advanced Forward By:</p>
        <input type = "number" id = "af-amount" value = 0>
    </div>
</body>

<script>
    let character_data = []
    for (var i = 0; i < 4; i++){
        character_data.push({"id": i, "spd":100})
    }

    let data = []
    character_data.forEach((character) => {
        let character_turn_data = []
        for(var i = 0; i < 20; i++){
            character_turn_data.push({
                "id":character.id,
                "turn": i,
                "spd":character.spd,
                "af":0,
                "av": 10000/character.spd * (i + 1)
            })
        }
        data.push(character_turn_data)
    })
    
    let character_spd = document.getElementsByClassName("spd");
    console.log(character_spd)
    var af = document.getElementById("af-amount");
    var selected;
    let svg = d3.select("#timeline");

    svg.selectAll(".bubble-tip")  
        .data(data)
        .join("g")
        .selectAll("rect")
        .data(function(d){
            return d;
        })
        .join("g")
        .attr("class", "bubble-tip")
        .attr("id", d=>"bubble-tip-"+d.turn)
        .style("display", "none")
        .append("rect")
            .attr("x", d => d.av - 25)
            .attr("y", d => 0)
            .attr("fill",d => "lightblue")
            .attr("fill-opacity", d=> 0.9)
            .attr("width", d=> 50)
            .attr("height", d=> 25);

    svg.selectAll(".bubble-tip")  
        .append("text")
            .text(d => "av: " + d.av)
            .style("font-family", "sans-serif")
            .style("font-size", 14)
            .style("text-align", "left")
            .style("display", "block")
            .attr("x", d => d.av - 25)
            .attr("y", d => 15)
            .attr("stroke", d=> "black")
            .attr("fill", d => "blue");

    svg.selectAll(".bubble")  
        .data(data)
        .join("g")
        .selectAll("circle")
        .data(function(d){
            return d;
        })
        .join("circle")
        .attr("class", "bubble")
        .attr("cx", d => d.av)
        .attr("cy", d => 30 * d.id)
        .attr("r", d => 10)
        .attr("stroke", "darkblue")
        .attr("fill", d => "lightblue");
    
    svg.selectAll(".bubble")
        .on("mouseover", function(event, d){
            d3.select("#bubble-tip-"+d.turn)
            .style("display","block");
            })
        .on("mouseout", function(event, d){
            d3.select("#bubble-tip-"+d.turn)
            .style("display","none");
            })
        .on("click", function(event, d){
            d3.select(this).attr("stroke", "black");
            af.value = d.af;
            selected = this;
        });
    
    af.oninput = function(){
        selected.__data__.af = af.value;
        update_timeline();
    }   

    character_spd = document.querySelectorAll('.spd')
    document.querySelectorAll('.spd').forEach((item, index) => {
        item.addEventListener('input', event => {
            console.log(character_data[index].spd)
            character_data[index].spd = item.value;
            update_timeline();
        })
    })

    function update_timeline(){
        for(var id = 0; id < data.length; id++){
            for(var turn = 0; turn < data[id].length; turn++){
                data[id][turn].spd = character_data[id].spd;
                if(turn == 0){
                    data[id][turn].av = 
                    10000/data[id][turn].spd * (1 - data[id][turn].af/100);
                } else{
                    data[id][turn].av = 
                        data[id][turn - 1].av 
                        + 10000/data[id][turn].spd
                        * (1 - data[id][turn].af/100);
                }
            }
        } 

        svg.selectAll(".bubble")
        .transition()
        .duration(200)
        .attr("cx", d=>{return d.av});
        
        svg.selectAll(".bubble-tip").select("rect")
        .transition()
        .duration(200)
        .attr("x", d=>d.av - 25);

        svg.selectAll(".bubble-tip").select("text")
        .transition()
        .duration(200)
        .attr("x", d=>d.av - 25)
        .text(d => "av: " + parseInt(d.av));
    }
</script>