
<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <link rel="stylesheet" href="mystyle.css">
</head>

<body>
    <span class = "character-config">
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
            <label for="spd">ERR</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "er">
        </div>
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
            <label for="spd">ERR</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "er">
        </div>
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
            <label for="spd">ERR</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "er">
        </div>
        <div>        
            <label for="spd">SPD</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "spd">
            <label for="spd">ERR</label>
            <input type = "number" min = "90" max = "200" value = "100" 
            class = "er">
        </div>
    </span>
    <div>
        <svg id = "timeline" width = 1000 height = 200>

        </svg>
    </div>
    <div>
        <p>Advanced Forward By:</p>
        <input type = "number" id = "af-amount" value = 0>
    </div>
</body>

<script>
    let colour = ["#6b40a0", "#a04045", "#40a09c", "#a09c40"]
    let character_data = []
    for (var i = 0; i < 4; i++){
        character_data.push({"id": i, "spd":100})
    }

    let data = []
    character_data.forEach((character) => {
        let character_turn_data = []
        for(var i = 0; i < 20; i++){
            character_turn_data.push({
                "id":character.id,
                "turn": i,
                "spd":character.spd,
                "af":0,
                "av": 10000/character.spd * (i + 1)
            })
        }
        data.push(character_turn_data)
    })
    
    let cycle_marker = [150, 250, 350, 450, 550, 650, 750]
    let sub_cycle_marker = [50, 100, 200, 300, 400, 500, 600, 700]

    var af = document.getElementById("af-amount");
    var selected;
    let svg = d3.select("#timeline");

    var row_height = 25;
    svg.selectAll(".cycle-marker")
        .data(cycle_marker)
        .join("line")
        .attr("class", "cycle-marker")
        .attr("x1", d => d)
        .attr("x2", d => d)
        .attr("y1", 0)
        .attr("y2", 200)
        .attr("stroke", "black");

    svg.selectAll(".sub-cycle-marker")
        .data(sub_cycle_marker)
        .join("line")
        .attr("class", "sub-cycle-marker")
        .attr("x1", d => d)
        .attr("x2", d => d)
        .attr("y1", 0)
        .attr("y2", 200)
        .attr("stroke", "grey");

    svg.selectAll(".turn-marker")  
        .data(data)
        .join("g")
        .selectAll("line")
        .data(function(d){
            return d;
        })
        .join("line")
        .attr("class", "turn-marker")
        .attr("x1", d => d.av)
        .attr("x2", d => d.av)
        .attr("y1", 0)
        .attr("y2", 200)
        .attr("stroke", d => colour[d.id]);

    svg.selectAll(".bubble")  
        .data(data)
        .join("g")
        .selectAll("circle")
        .data(function(d){
            return d;
        })
        .join("circle")
        .attr("class", "bubble")
        .attr("cx", d => d.av)
        .attr("cy", d => row_height * (d.id + 1))
        .attr("r", d => 10)
        .attr("fill", d=> colour[d.id]);
        


        
    svg.selectAll(".bubble-tip")  
        .data(data)
        .join("g")
        .selectAll("rect")
        .data(function(d){
            return d;
        })
        .join("g")
        .attr("class", "bubble-tip")
        .attr("id", d=>"bubble-tip-"+ d.id + "-" + d.turn)
        .style("display", "none")
        .append("rect")
            .attr("x", d => d.av + 25)
            .attr("y", d => (d.id + 0.5) * row_height)
            .attr("fill",d => "lightblue")
            .attr("fill-opacity", d=> 0.9)
            .attr("width", d=> 50)
            .attr("height", d=> 25);

    svg.selectAll(".bubble-tip")  
        .append("text")
            .text(d => "av: " + d.av)
            .style("font-family", "sans-serif")
            .style("font-size", 14)
            .style("text-align", "left")
            .style("display", "block")
            .attr("x", d => d.av + 25)
            .attr("y", d => (d.id + 1) * row_height)
            .attr("stroke", d=> colour[d.id])
            .attr("fill", d => "white");

    svg.selectAll(".bubble")
        .on("mouseover", function(event, d){
            d3.select("#bubble-tip-"+ d.id + "-" + d.turn)
            .style("display","block");
        })
        .on("mouseout", function(event, d){
            d3.select("#bubble-tip-"+ d.id + "-" + d.turn)
            .style("display","none");
            })
        .on("click", function(event, d){
            d3.select(this).attr("stroke-dasharray", 5).attr("stroke", "black");
            af.value = d.af;
            selected = this;
        });
    
    af.oninput = function(){
        selected.__data__.af = af.value;
        update_timeline();
    }   

    character_spd = document.querySelectorAll('.spd')
    document.querySelectorAll('.spd').forEach((item, index) => {
        item.addEventListener('input', event => {
            character_data[index].spd = item.value;
            update_timeline();
        })
    })

    function update_timeline(){
        for(var id = 0; id < data.length; id++){
            for(var turn = 0; turn < data[id].length; turn++){
                data[id][turn].spd = character_data[id].spd;
                if(turn == 0){
                    data[id][turn].av = 
                    10000/data[id][turn].spd * (1 - data[id][turn].af/100);
                } else{
                    data[id][turn].av = 
                        data[id][turn - 1].av 
                        + 10000/data[id][turn].spd
                        * (1 - data[id][turn].af/100);
                }
            }
        } 

        svg.selectAll(".turn-marker")
        .transition()
        .duration(200)
        .attr("x1", d=>{return d.av})
        .attr("x2", d=>{return d.av});

        svg.selectAll(".bubble")
        .transition()
        .duration(200)
        .attr("cx", d=>{return d.av});
        
        svg.selectAll(".bubble-tip").select("rect")
        .transition()
        .duration(200)
        .attr("x", d=>d.av + 25);

        svg.selectAll(".bubble-tip").select("text")
        .transition()
        .duration(200)
        .attr("x", d=>d.av + 25)
        .text(d => "av: " + parseInt(d.av));
    }
</script>